<!-- verified: agorbachev 03.05.2022 -->

<!-- 13.1.1 -->
##  Сообщения ICMPv4 и ICMPv6

В этом разделе вы узнаете о различных типах протоколов сообщений управления Интернетом (ICMP) и средствах, которые используются для их отправки.

Несмотря на то, что IP является протоколом наибольших усилий, пакет TCP/IP обеспечивает сообщения об ошибках и информационные сообщения при взаимодействии с другим IP-устройством. Эти сообщения отправляются с помощью ICMP-сервисов. Назначение таких сообщений — предоставлять обратную связь о проблемах, связанных с обработкой IP-пакетов в определенных условиях, а не повышать надежность протокола IP. Из соображений безопасности сообщения ICMP не обязательны и часто даже не разрешены в сети.

ICMP может использоваться как с IPv4, так и с IPv6. ICMPv4 — это протокол обмена сообщениями для IPv4. Протокол ICMPv6 предоставляет те же сервисы для IPv6, но при этом включает в себя дополнительные функциональные возможности. В рамках данного курса термин ICMP будет использоваться для обозначения как ICMPv4, так и ICMPv6.

Существует множество типов ICMP-сообщений и причин их отправки. Сообщения ICMP, общие для ICMPv4 и ICMPv6 и обсуждаемые в этом модуле, включают:

* Достижимость узла
* Узел назначения или сервис недоступен
* Превышен интервал ожидания

<!-- 13.1.2 -->
## Достижимость узла

Эхо-сообщение ICMP можно использовать для проверки доступности узла в IP-сети. Локальный узел отправляет узлу эхо-запрос ICMP. Если узел доступен, узел назначения отправляет эхо-ответ. На рисунке нажмите кнопку «Воспроизведение», чтобы посмотреть видеоролик о принципе работы эхо-запроса и эхо-ответа ICMP. Такое использование ping-запросов по протоколу ICMP легло в основу утилиты **ping**.

![](./assets/13.1.2.gif)

<!-- 13.1.3 -->
## Узел назначения или сервис недоступен

Когда узел или шлюз получает пакет, который не может доставить, он может использовать ICMP-сообщение «Узел назначения недоступен» (Destination Unreachable), чтобы сообщить источнику о том, что узел назначения или сервис для этого пакета недоступен. Такое сообщение содержит код, определяющий причину, по которой пакет не может быть доставлен.

Примеры некоторых кодов сообщений о недоступном узле назначения для ICMPv4:

* 0 — сеть недоступна;
* 1 — узел недоступен;
* 2 — протокол недоступен;
* 3 — порт недоступен.

Примеры некоторых кодов сообщений о недоступном узле назначения для ICMPv6:

* 0 - нет маршрута до пункта назначения
* 1 - Связь с пунктом назначения административно запрещена (например, брандмауэр)
* 2 — За пределами области адреса источника
* 3 - Адрес недоступен
* 4 — порт недоступен.

**Примечание**: Протокол ICMPv6 имеет практически такие же коды сообщений о недоступном узле назначения.

<!-- 13.1.4 -->
## Превышен интервал ожидания

Сообщения ICMPv4 о превышении интервала ожидания (Time Exceeded) используется маршрутизатором для указания на то, что пакет невозможно переслать, поскольку значение в поле «Время существования» (Time to Live, TTL) пакета было изменено на 0. Если маршрутизатор получает пакет и изменяет значение в поле TTL IPv4-пакета на нуль, он отбрасывает пакет и отправляет на исходный узел сообщение о превышении интервала ожидания.

Протокол ICMPv6 также отправляет сообщение о превышении интервала ожидания, в случае если маршрутизатор не может переслать IPv6-пакет из-за истечения его срока действия. В протоколе IPv6 поле TTL отсутствует; чтобы выяснить, не истек ли срок действия пакета, используется поле «предел переходов» (hop limit).

**Примечание**: Инструмент  **traceroute** использует сообщения о превышении времени.

<!-- 13.1.5 -->
## Сообщения ICMPv6

Информационные сообщения и сообщения об ошибках, возникающие в протоколе ICMPv6, очень похожи на сообщения о контроле и ошибках, используемые протоколом ICMPv4. Однако протокол ICMPv6 отличается расширенной функциональностью и новыми возможностями, которых нет в ICMPv4. Сообщения ICMPv6 инкапсулируются в IPv6-пакеты.

ICMPv6 включает четыре новых протокола в составе протокола обнаружения соседних узлов (Neighbor Discovery Protocol, ND или NDP).

Обмен сообщениями между маршрутизатором IPv6 и устройством IPv6, включая динамическое распределение адресов, осуществляется следующим образом:

* Сообщение «Запрос к маршрутизатору» (Router Solicitation, RS)
* Сообщение «Ответ маршрутизатора» (Router Advertisement, RA)

Обмен сообщениями между устройствами IPv6, включая обнаружение повторяющихся адресов и разрешение адресов, осуществляется следующим образом:

* Сообщение с запросом поиска соседей (NS)
* Сообщение об объявлении соседних узлов (NA)

**Примечание**: ND-протокол ICMPv6 также включает сообщение перенаправления, которое имеет аналогичную с сообщением перенаправления, используемым в ICMPv4, функцию.

### Сообщения RA

Сообщения RA отправляются маршрутизаторами с поддержкой IPv6 каждые 200 секунд для предоставления информации об адресации узлам с поддержкой IPv6. Сообщение RA может включать такие данные об адресах для хостов, как префикс, длина префикса, DNS-адрес и доменное имя. Узел, использующий SLAAC, установит в качестве своего шлюза по умолчанию локальный адрес канала маршрутизатора, отправившего RA.

![](./assets/13.1.5-1.svg)


R1 отправляет сообщение RA: "Привет всем устройствам с поддержкой IPv6. Я R1, и вы можете использовать SLAAC для создания глобального одноадресного адреса IPv6. Префикс: 2001:db8:acad:1::/64. Кстати, используйте мой локальный адрес канала fe80::1 в качестве шлюза по умолчанию."

<!--
R1 отправляет рекламное сообщение маршрутизатора RA FF02::1 адрес многоадресной рассылки всех узлов, который достигнет PC1.
-->

### Сообщение RS

Маршрутизатор с поддержкой IPv6 также отправит сообщение RA в ответ на сообщение RS. На рисунке PC1 отправляет сообщение RS, чтобы определить, как получать информацию об адресах IPv6 динамически.

![](./assets/13.1.5-2.svg)


R1 отвечает РС с сообщением РА.

1.  PC1 отправляет сообщение RS: «Привет, я только что загрузился. Есть ли IPv6 маршрутизатор в сети? Мне нужно знать, как динамически получать информацию об адресах IPv6».
2.  R1 отвечает сообщением RА. "Привет всем устройствам с поддержкой IPv6. Я R1, и вы можете использовать SLAAC для создания глобального одноадресного адреса IPv6. Префикс: 2001:db8:acad:1::/64. Кстати, используйте мой локальный адрес канала fe80::1 в качестве шлюза по умолчанию"

### Сообщение NS

Когда устройству назначается глобальный одноадресный IPv6-адрес или одноадресный локальный адрес канала, оно может выполнить обнаружение дублированного адреса (DAD), чтобы гарантировать, что адрес IPv6 является уникальным. Для проверки уникальности адреса устройство отправляет сообщение NS с собственным IPv6-адресом в качестве целевого, как показано на рисунке.

Если другому устройству в сети присвоен этот адрес, оно ответит сообщением NA. Это сообщение NA уведомляет устройство-отправителя о том, что данный адрес уже используется. Если соответствующее сообщение NA не возвращается в течение определенного периода времени, индивидуальный адрес признается уникальным и допустимым к использованию.

**Примечание**: Процесс обнаружения дублирующихся адресов не обязателен, Однако, документ RFC 4861 рекомендует выполнять его для индивидуальных адресов.

![](./assets/13.1.5-3.svg)


PC1 отправляет сообщение NS для проверки уникальности адреса: "Если ли тот, кто имеет адрес IPv6 2001:db8:acad:1::10, пришлите мне ваш MAC-адрес?"

### Сообщение NA

Протокол разрешения адресов используется в том случае, когда устройству в локальной сети (LAN) известен индивидуальный IPv6-адрес назначения, но неизвестен MAC-адрес Ethernet. Для того чтобы определить MAC-адрес назначения, устройство отправляет сообщение NS на адрес запрашиваемого узла. Сообщение включает известный (целевой) IPv6-адрес. Устройство с целевым IPv6-адресом отправляет в ответ сообщение NA, содержащее его MAC-адрес Ethernet.

На рисунке R1 отправляет сообщение NS в 2001:db8:acad:1::10 с запросом его MAC-адреса.

![](./assets/13.1.5-4.svg)


1.  R1 отправляет сообщение NS разрешения адреса. «Если ли тот, кто имеет IPv6-адрес 2001:db8:acad:1::10, пришлите ваш MAC-адрес?»
2.  PC1 отвечает сообщением NA. "Я 2001:db8:acad:1::10 и мой MAC-адрес 00:aa:bb:cc:dd:ee."

<!-- 13.1.6 -->
<!-- quiz -->


<!-- verified: agorbachev 03.05.2022 -->

<!-- 8.5.1 -->
## Решение о пересылке пакетов роутера

В предыдущем разделе рассматривались таблицы маршрутизации узлов. Большинство сетей также содержат роутеры, которые являются промежуточными устройствами. Они тоже содержат таблицы маршрутизации. В этом разделе рассматриваются операции роутера на сетевом уровне. Когда узел отправляет пакет другому узлу, он использует свою таблицу маршрутизации, чтобы определить место отправки пакета. Если узел назначения находится в удаленной сети, пакет пересылается на шлюз по умолчанию, который обычно является локальным роутером.

Когда пакет поступает на интерфейс роутера, он считывает IP-адрес назначения и просматривает свою таблицу маршрутизации, определяя, куда нужно переслать пакет. Таблица содержит список всех известных сетевых адресов (префиксов) и куда пересылать пакет. Эти записи известны как записи маршрута или маршруты. Роутер пересылает пакет, используя наилучшую соответствующую запись маршрута.

![](./assets/8.5.1.svg)


1.  Пакет поступает на интерфейс Gigabit Ethernet 0/0/0 роутера R1. R1 деинкапсулирует заголовок Ethernet уровня 2 и окончание.
2.  Роутер R1 проверяет адрес назначения IPv4 пакета и ищет наилучшее соответствие в своей таблице маршрутизации IPv4. Запись маршрута указывает, что этот пакет должен быть перенаправлен на роутер R2.
3.  Роутер R1 инкапсулирует пакет в новый заголовок и концевик Ethernet и пересылает пакет на R2.

В следующей таблице приведены соответствующие сведения из таблицы маршрутизации R1.

### R1 Routing Table

| Маршрут | Адрес следующего перехода или <br> исходящий интерфейс |
| --- | --- |
| 192.168.10.0 /24 | G0/0/0 |
| 209.165.200.224/30 | G0/0/1 |
| **10.1.1.0/24** | **через R2** |
| Маршрут по умолчанию 0.0.0.0/0 | через R2 |

<!-- 8.5.2 -->
## Таблица маршрутизации IP-роутера

Таблица маршрутизации роутера содержит записи сетевого маршрута, перечисляющие все возможные известные сетевые назначения.

В таблице маршрутизации хранятся три типа записей.

* **Сети с прямым подключением (Directly-connected networks).** Эти записи сетевого маршрута являются активными интерфейсами роутера. Роутеры добавляют маршрут с прямым подключением, когда интерфейс настроен с IP-адресом и активирован. Каждый из интерфейсов подключен к разному сегменту сети. На рисунке сети с прямым подключением в таблице маршрутизации R1 IPv4 будут иметь значения 192.168.10.0/24 и 209.165.200.224/30.
* **Удаленные сети.** Это сети, подключенные к другим роутерам. Роутеры узнают о удаленных сетях либо путем явной настройки администратором, либо путем обмена информацией с помощью протокола динамической маршрутизации. На рисунке удаленная сеть в таблице маршрутизации R1 IPv4 будет иметь значение 10.1.1.0/24.
* **Маршрут по умолчанию.** Как и узел, большинство роутеров также включают запись маршрута по умолчанию в качестве последнего средства, если иного маршрута до нужной сети в таблице маршрутизации нет. Маршрут по умолчанию используется, если в таблице IP-маршрутизации нет лучшего (наибольшего) соответствия. На рисунке таблица маршрутизации R1 IPv4, скорее всего, будет включать маршрут по умолчанию для пересылки всех пакетов роутеру R2.

На рисунке представлены сети с прямым подключением и удаленные сети роутера R1.

![](./assets/8.5.2.svg)


R1 имеет две сети прямого подключения:

* 192.168.10.0/24
* 209.165.200.224/30

R1 также имеет удаленные сети (например, 10.1.1.0/24 и Интернет), о которых он может узнать.

Роутер может узнать о удаленных сетях одним из двух способов:

* **вручную** (данные об удаленных сетях вручную вводятся в таблицу с использованием статических маршрутов);
* **динамически** (удаленные маршруты автоматически добавляются с использованием протокола динамической маршрутизации).

<!-- 8.5.3 -->
## Статическая маршрутизация

**Статические маршруты** — это записи маршрутов, которые настраиваются вручную. Они включают в себя адрес удаленной сети и IP-адрес роутера следующего перехода. На рисунке показан пример статического маршрута, настроенного вручную на роутере R1.

![](./assets/8.5.3-1.svg)


R1 настраивается вручную со статическим маршрутом для достижения сети 10.1.1.0/24. Если этот путь изменится, R1 потребуется новый статический маршрут.

В случае изменения топологии сети статический маршрут не обновляется автоматически и должен быть перенастроен вручную. Например, на рисунке R1 имеет статический маршрут для достижения сети 10.1.1.0/24 через R2. Если этот путь больше не доступен, потребуется перенастроить R1 на новый статический маршрут к сети 10.1.1.0/24 через R3. Поэтому роутер R3 должен иметь запись маршрута в таблице для отправки пакетов, предназначенных для 10.1.1.0/24, на R2.

![](./assets/8.5.3-2.svg)


Если маршрут от R1 через R2 больше недоступен, необходимо настроить новый статический маршрут через R3. Он не корректируется автоматически для изменения топологии.

Статическая маршрутизация имеет следующие требования:

* статический маршрут должен быть настроен вручную;
* администратору необходимо перенастроить статический маршрут, если есть изменения в топологии и статический маршрут больше не является жизнеспособным;
* статический маршрут подходит для небольшой сети и когда избыточных каналов мало или нет;
* статический маршрут обычно используется с протоколом динамической маршрутизации для настройки маршрута по умолчанию.

<!-- 8.5.4 -->
## Динамическая маршрутизация

Протокол динамической маршрутизации позволяет роутерам автоматически получать информацию о удаленных сетях, включая маршрут по умолчанию, от других роутеров. Роутеры, использующие протоколы динамической маршрутизации, автоматически обмениваются информацией с другими роутерами и выполняют обновления в случае каких-либо изменений в топологии без участия сетевого администратора. При изменении топологии сети роутеры совместно используют эту информацию с помощью протокола динамической маршрутизации и автоматически обновляют свои таблицы.

Протоколы динамической маршрутизации включают OSPF и расширенный протокол маршрутизации внутреннего шлюза (EIGRP). На рисунке показан пример того, как роутеры R1 и R2 автоматически используют сетевую информацию с помощью протокола маршрутизации OSPF.

![](./assets/8.5.4-1.svg)


* R1 использует протокол маршрутизации OSPF, чтобы сообщить R2 о сети 192.168.10.0/24.
* R2 использует протокол маршрутизации OSPF, чтобы сообщить R1 о сети 10.1.1.0/24.

Базовая конфигурация требует, чтобы администратор сети включил непосредственно подключенные сети в рамках протокола динамической маршрутизации. Протокол динамической маршрутизации будет автоматически выполнять следующие действия:

* обнаружение удаленных сетей;
* обновление данных маршрутизации;
* выбор оптимального пути к сетям назначения;
* поиск нового оптимального пути в случае, если текущий путь недоступен.

Если роутер вручную настроен со статическим маршрутом или узнает о удаленной сети динамически с помощью протокола динамической маршрутизации, адрес удаленной сети и адрес следующего перехода вводятся в таблицу IP-маршрутизации. Как показано на рисунке, при изменении топологии сети роутеры будут автоматически корректироваться и пытаться найти новый оптимальный путь.

![](./assets/8.5.4-2.svg)


R1, R2 и R3 используют протокол динамической маршрутизации OSPF. При изменении топологии сети они могут автоматически корректироваться, чтобы найти новый оптимальный путь.

**Примечание.** Во многих случаях роутеры одновременно используют протоколы динамической маршрутизации и статические маршруты.

<!-- 8.5.5 -->
## Видео: таблица маршрутизации маршрутизатора IPv4 

В отличие от таблицы маршрутизации главного компьютера, в ней отсутствуют заголовки столбцов, определяющие информацию, которая содержится в таблице маршрутизации роутера. Важно узнать значение различных элементов, которые содержатся в каждой записи таблицы маршрутизации.

Просмотрите видео о таблице маршрутизации для IPv4.

![youtube](https://www.youtube.com/watch?v=pt_Qw1Jfo5w)

<!-- 8.5.6 -->
## Введение в таблицу маршрутизации IPv4

Обратите внимание, что на рисунке R2 подключен к Интернету. Поэтому администратор настраивает R1 со статическим маршрутом, отправляющим пакеты R2, если в таблице маршрутизации нет конкретной записи, соответствующей IP-адресу назначения. R1 и R2 также используют маршрутизацию OSPF для объявления напрямую подключенных сетей.

![](./assets/8.5.6.svg)


```
R1# show ip route
Codes: L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP
       D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area 
       N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2
       E1 - OSPF external type 1, E2 - OSPF external type 2
       i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2
       ia - IS-IS inter area, * - candidate default, U - per-user static route
       o - ODR, P - periodic downloaded static route, H - NHRP, l - LISP
       a - application route
       + - replicated route, % - next hop override, p - overrides from PfR
Gateway of last resort is 209.165.200.226 to network 0.0.0.0
S*    0.0.0.0/0 [1/0] via 209.165.200.226, GigabitEthernet0/0/1
      10.0.0.0/24 is subnetted, 1 subnets
O        10.1.1.0 [110/2] via 209.165.200.226, 00:02:45, GigabitEthernet0/0/1
      192.168.10.0/24 is variably subnetted, 2 subnets, 2 masks
C        192.168.10.0/24 is directly connected, GigabitEthernet0/0/0
L        192.168.10.1/32 is directly connected, GigabitEthernet0/0/0
      209.165.200.0/24 is variably subnetted, 2 subnets, 2 masks
C        209.165.200.224/30 is directly connected, GigabitEthernet0/0/1
L        209.165.200.225/32 is directly connected, GigabitEthernet0/0/1
R1#
```

Команда **show ip route** привилегированного режима EXEC используется для просмотра таблицы маршрутизации IPv4 на роутере Cisco IOS. В примере показана таблица маршрутизации IPv4 роутера R1. В начале каждой записи таблицы маршрутизации находится код, который используется для идентификации типа маршрута или способа его изучения. К общим источникам маршрутов (кодам) относятся следующие:

* **L** – IP-адрес локального интерфейса с прямым подключением;
* **C** – присоединенная напрямую сеть;
* **S** – статический маршрут был вручную настроен администратором;
* **O** – OSPF;
* **D** – EIGRP.

В таблице маршрутизации отображаются все известные маршруты назначения IPv4 для R1.

Присоединенная напрямую маршрут создается автоматически, когда интерфейс роутера настроен с информацией об IP-адресе и активирован. Роутер добавляет две записи маршрута с кодами C (т.е. подключенная сеть) и L (т.е. IP-адрес локального интерфейса подключенной сети). Записи маршрута также определяют интерфейс выхода для доступа к сети. Две напрямую подключенные сети в этом примере — 192.168.10.0/24 и 209.165.200.224/30.

Роутеры R1 и R2 также используют протокол динамической маршрутизации OSPF для обмена информацией о роутере. В примере таблицы маршрутизации R1 содержит запись маршрута для сети 10.1.1.0/24, которую он динамически узнал от R2 по протоколу маршрутизации OSPF.

Маршрут по умолчанию (default route) имеет сетевой адрес всех нулей. Например, сетевой адрес IPv4 — 0.0.0.0. Статическая запись маршрута в таблице начинается с кода S*, как показано в примере.

<!-- 8.5.7 -->
<!-- quiz -->

